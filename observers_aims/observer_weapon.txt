observer
    #TODO:
    # include observers for WEAPON_MISS and WEAPON_KILLED
    
    # enable PLATFORM_INITIALIZED platformInitialized #
    # enable PLATFORM_INITIALIZED platformTracker #with the string inclusino, this will be called within the platformInitialized
    #enable PLATFORM_DELETED PlatformDel #
    #enable PLATFORM_KILLED # deprecated in 2.9
    enable WEAPON_TERMINATED WeaponTerminated_observer_weapon # # wdl_missile_out
    #enable WEAPON_TERMINATED mslendMSL
    enable WEAPON_FIRED WeaponFired_observer_weapon  # #uncommented to add the platform tracker to
    #enable LOCAL_TRACK_UPDATED compareRange
    #enable LOCAL_TRACK_UPDATED LocalTrackUpdate
    #enable LOCAL_TRACK_UPDATED digitalSpine #
    #enable LOCAL_TRACK_UPDATED digitalSpineTracks #
    #enable LOCAL_TRACK_INITIATED LocalTrackCreated #new
    #enable LOCAL_TRACK_DROPPED LocalTrackDropped #new
    #enable LOCAL_TRACK_CORRELATION tester2 #new
    #enable LOCAL_TRACK_DECORRELATION tester2 #new
    enable SIMULATION_INITIALIZING SimulationInitializing_observer_weapon # need for header line creation
    #enable CRASHED_INTO_GROUND ImpactedGround
    #enable PLATFORM_ADDED PlatformAdded
    #enable SENSOR_TRACK_INITIATED SensorTrackInit #
    #enable SENSOR_TRACK_DROPPED SensorTrackDrop #
end_observer 
    

script_variables

   double wpn_red_aircraft    = 0;
   double wpn_blue_aircraft   = 0;
   
   double distFromPlat;
   
   double commRange = 0.0;      # Can be safely removed after merged with commit 0808507db04
   double packet_loss;
   int increment = 0;
   # ^^^ These three (commRange, packet_loss, increment) really shouldn't be here. ^^^
   
   # Added by LCB to tinker with unique red track observer
   #extern bool drawingFlag;
   global double quality = 1;
  
   global Array<double> snrAbs = {
     -10, 	   0,
		0 ,	   0,
		1.45,	   64000,
		2.80,	   128000,
      5.38,    238000
      };
  
   ### Define files to write outputs to
#   string wpn_open_method;
#   int wpn_run_num = WsfSimulation.RunNumber();
#   if(wpn_run_num == 1)
#      {wpn_open_method = "out";}
#   else
#      {wpn_open_method = "append";}
  
  string wpn_open_method = "out";
   # creates a lot of the output files
   #FileIO wdl_mess_out = FileIO();
   FileIO wdl_missile_out = FileIO();

   string rel_path_2 = Path.GetWorkingDirectory().ToString() + "/output/Missile_Output";

   
   # confirms files can be used
   writeln(rel_path_2);
#   assert(wdl_mess_out.Open((rel_path + (string)wpn_run_num + ".csv"), "out"),
#     "WeaponComm_Output.csv output file falied to open");
    
   assert(wdl_missile_out.Open((rel_path_2 + "_" + (string)OVERALL_RUN_NUMBER + ".csv"), wpn_open_method),
     "Missile_Output.csv output file falied to open");
end_script_variables

# include_once observers_aims/observer_utils.txt # All uses of these functions are commented out


# Writes the header to the output file
script void write_file_observer_weapon()
   
   Array<string> header = {"Treatment", 
                           "Replicate",
                           "Seed",
                           "TIME_NOW",
                           "Event",
                           "platSide",
                           "platName",
                           "platType",
                           "platIndex", 
                           "ShootingPlat",
                           "ShootingType",
                           "TargetPlat",
                           "TargetType",
                           "Latitude", 
                           "Longitude",
                           "Altitude", 
                           "Velocity", 
                           "Track ID", 
                           "Track Quality", 
                           "Pk",
                           "Pk Drawn",
                           "Result",
                           "Miss Distance",
                           "Firing Distance (NMI)",
                           "AC to MSL Range (NMI)",
                           };

   string header_line = ",".Join(header);
                                 
   wdl_missile_out.Write(header_line);
   wdl_missile_out.Write("\n");
   
end_script


script void WeaponTerminated_observer_weapon(WsfWeaponEngagement aWeaponEngagement)
   double simTime = TIME_NOW;
   WsfPlatform target, shooter;
   WsfTrack trackMSL;
   int firingTrack;
   WsfCommInteraction commInt;
   WsfPlatform missile = aWeaponEngagement.WeaponPlatform();
   int target_index, shooter_index;
   Array<string> words;
   string targetName, targetType, targetSide, firingSide, firingName, firingType;
   
   string weapon_name = aWeaponEngagement.WeaponPlatformName();
   string weapon_type = aWeaponEngagement.WeaponSystemType(); #aWeaponEngagement.WeaponPlatform().Type();
   double PkDrawn = aWeaponEngagement.PkDrawn();
   double Pk = aWeaponEngagement.Pk()*aWeaponEngagement.PkDegrade();
   double heading_start;            
   double weaponSpeed = aWeaponEngagement.WeaponPlatform().Speed();
   int trackID = aWeaponEngagement.WeaponPlatform().AuxDataInt("GlobalTrackNumber");
   

   shooter = aWeaponEngagement.FiringPlatform();
   if(shooter.IsValid()) 
   {
      firingName = shooter.Name();
      firingSide = shooter.Side();
      firingType = shooter.Type();
   } else {
      # WARNING: Platform index is unreliable if the platform is gone. You'll just get pointed to some other platform.
      #shooter_index = aWeaponEngagement.WeaponPlatform().AuxDataInt("shooterIndex");
      #shooter = WsfSimulation.PlatformEntry(shooter_index);
      firingName = "unknown";
      firingSide = "unknown";
      firingType = "unknown";
   }
   
   target = aWeaponEngagement.TargetPlatform();
   if(target.IsValid()) 
   {
      targetName = target.Name();
      targetType = target.Type();
   } else {
      targetName = "unknown";
   }
   int weaponID = missile.Index();         
   #DETONTATED
   double weaponDetonateTime = aWeaponEngagement.CompletionTime();
   double detonateLat = aWeaponEngagement.WeaponLocation().Latitude();
   double detonateLon = aWeaponEngagement.WeaponLocation().Longitude();
   double detonateAlt = aWeaponEngagement.WeaponLocation().Altitude();
   
   double missDist;
   string result_string = aWeaponEngagement.TargetResult();
   string incidental_string = aWeaponEngagement.IncidentalResult();
   
   if(aWeaponEngagement.MissDistance() <= 1.5)
      missDist = 0;
   else
      missDist = aWeaponEngagement.MissDistance();

   if(result_string == "KILLED")
   {
      #result_string = "TGT KILLED";
   }
   else
   {
      result_string = "TGT NOT KILLED";
   }
   
   
   words = {
               (string)TREATMENT_NUMBER, 
               (string)REPLICATE_NUMBER,
               (string)WsfSimulation.RandomSeed(), 
               (string)simTime,
               (string)"WEAPON_TERMINATED",    # Event               
               (string)firingSide.Upper(),     # Firing Platform Side
               (string)weapon_name,    # Weapon Name               
               (string)weapon_type,    # Weapon Type
               (string)weaponID,           
               (string)firingName,     # Shooter Platform Name               
               (string)firingType,
               (string)targetName,     # Target Platform Name
               (string)targetType,     # Target Platform Type     
               (string)detonateLat,    # Weapon Location Latitude at Event
               (string)detonateLon,    # Weapon Location Longitude at Event               
               (string)detonateAlt,    # Weapon Altitude at Event       
               (string)weaponSpeed,    # Weapon Speed at Event               
               (string)trackID,        # Track ID assigned to Weapon
               (string)"TrackQuality", # Track Quality               
               (string)Pk,
               (string)PkDrawn,        # Probability of kill assigned to the weapon
               (string)result_string,
               (string)missDist,          
               (string)"WEAPON_TERMINATED",    # Was firing_distance_nmi, but only applicable to WEAPON_FIRED
               (string)distFromPlat,                                             
               #(string)weaponDetonateTime,
               #(string)finalTrackUpdateCount
            };
            
   string line = ",".Join(words);
           
   wdl_missile_out.Write(line);
   wdl_missile_out.Write("\n");  
   
   
   #MTC - added checks for target and shooter being alive
   #Dead platforms are grabbed based on weapon-target-shooter trios stored at launch
end_script


script void SimulationInitializing_observer_weapon() # need to have the header of output file created
   # NAS - need to set the math random seed on sim initialize, seems kind of ridiculous that a monte carlo sim would not automate this
   MATH.SetSeed(WsfSimulation.RandomSeed());
   
#   if (WsfSimulation.RunNumber() == 1)
#   {
      write_file_observer_weapon();
      #wpn_write_IO.Open(wpn_write_path, "out"); # Keep in case of MC runs
      #write_out.Close();
#   }
#   else # KEEP in case we need for MC runs
#   {
#      # write_file_observer_weapon(); # this would rewrite the header file
#      wpn_write_IO.Open(wpn_write_path,"append");
#   }
#   
end_script


script void WeaponFired_observer_weapon(WsfWeaponEngagement aWeaponEngagement, WsfTrack aTargetTrack)
   double simTime = TIME_NOW;

   WsfPlatform target, shooter;
   #extern void platformTracker(WsfPlatform,string); 
   WsfTrack trackMSL;
   int firingTrack;
   WsfCommInteraction commInt;
   WsfPlatform missile = aWeaponEngagement.WeaponPlatform();
   int target_index, shooter_index;
   Array<string> words;
   string targetName, targetSide, targetType, firingSide, firingName, firingType, weaponType;
   
   string weapon_name = aWeaponEngagement.WeaponPlatformName();
   string weapon_type = aWeaponEngagement.WeaponSystemType(); #aWeaponEngagement.WeaponPlatform().Type();
   double PkDrawn = aWeaponEngagement.PkDrawn();
   double Pk = aWeaponEngagement.Pk()*aWeaponEngagement.PkDegrade();
   double heading_start;
  
    #FIRED
   double weaponFireTime = aWeaponEngagement.StartTime();
   shooter = aWeaponEngagement.FiringPlatform();
   firingName = shooter.Name();
   firingSide = shooter.Side();
   firingType = shooter.Type();
   target = aWeaponEngagement.TargetPlatform();
   targetName = target.Name();
   targetType = target.Type();
   int weaponID = missile.Index();
   double fireLat = aWeaponEngagement.WeaponLocationAtLaunch().Latitude();
   double fireLon = aWeaponEngagement.WeaponLocationAtLaunch().Longitude();
   double fireAlt = aWeaponEngagement.WeaponLocationAtLaunch().Altitude();
   double weaponSpeed = aWeaponEngagement.WeaponPlatform().Speed();  
   int trackID = aTargetTrack.GlobalTrackNumber();
   #aWeaponEngagement.TargetTrackId().ToString();
  aWeaponEngagement.WeaponPlatform().SetAuxData("GlobalTrackNumber", trackID);
  aWeaponEngagement.WeaponPlatform().SetAuxData("targetIndex", target.Index());
  aWeaponEngagement.WeaponPlatform().SetAuxData("shooterIndex", shooter.Index());
   
   WsfGeoPoint targetLoc = aWeaponEngagement.TargetLocationAtLaunch();
   WsfGeoPoint launchLoc = aWeaponEngagement.WeaponLocationAtLaunch();
   double firing_distance_nmi = launchLoc.SlantRangeTo(targetLoc)*MATH.NM_PER_M(); # range at time of shot
   
   words = {
               (string)TREATMENT_NUMBER, 
               (string)REPLICATE_NUMBER,
               (string)WsfSimulation.RandomSeed(), 
               (string)simTime,
               (string)"WEAPON_FIRED", # Event               
               (string)firingSide.Upper(),     # Firing Platform Side
               (string)weapon_name,    # Weapon Name               
               (string)weapon_type,    # Weapon Type
               (string)weaponID,           
               (string)firingName,     # Shooter Platform Name               
               (string)firingType,
               (string)targetName,     # Target Platform Name
               (string)targetType,     # Target Platform Type     
               (string)fireLat,        # Weapon Location Latitude at Event
               (string)fireLon,        # Weapon Location Longitude at Event               
               (string)fireAlt,        # Weapon Altitude at Event       
               (string)weaponSpeed,    # Weapon Speed at Event               
               (string)trackID,        # Track ID assigned to Weapon
               (string)"TrackQuality", # Track Quality               
               (string)Pk,
               (string)PkDrawn,        # Probability of kill assigned to the weapon
               (string)"WEAPON_FIRED",           # Was result_string, but only applicable to WEAPON_TERMINATED
               (string)"WEAPON_FIRED",           # was missDist, but only applicable to WEAPON_TERMINATED
               (string)firing_distance_nmi,
               (string)distFromPlat,
               

               #(string)weaponFireTime,
               #(string)"FIRE_EVENT",
               #(string)"FIRE_EVENT",
               #(string)finalTrackUpdateCount
            };
            
   string line = ",".Join(words);
           
   wdl_missile_out.Write(line);
   wdl_missile_out.Write("\n");  
end_script