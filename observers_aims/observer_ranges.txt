# Observer for Platform Position Recording
# Captures platform positions and sensor ranges at T=2.0s after initial placement

script_variables
   FileIO position_csv = FileIO();
   bool positions_recorded = false;
   bool file_is_open = false;
   string csv_filename;
end_script_variables


execute at_time 0.001 s absolute
   csv_filename = "output/platform_positions_run_" + (string)OVERALL_RUN_NUMBER + ".csv";
   
   Array<string> headers = {
      "Time",
      "Platform_Name", 
      "Platform_Type",
      "Side",
      "Latitude",
      "Longitude",
      "Altitude_ft",
      "Lat_NM_from_53N",
      "Lon_NM_from_14E",
      "Sensor_Range_NM"
   };
   
   string header_line = ",".Join(headers);
   position_csv.Write(header_line);
   position_csv.Write("\n");
end_execute

# get large RCS sensor range from sensor definitions
script double getLargeRCSSensorRange(WsfPlatform aPlatform)
   double range_nm = 0.0;
   
   # iterate through platform's sensors to find the large RCS sensor
   for (int i = 0; i < aPlatform.SensorCount(); i += 1)
   {
      WsfSensor sensor = aPlatform.SensorEntry(i);
      
      # check if sensor is of type G425_SENSOR_BASE
      if (WsfSensor.IsA_TypeOf(sensor.Type(), "G425_SENSOR_BASE"))
      {
         # check if this is the large RCS sensor by name
         if (sensor.Name().Contains("LARGE"))
         {
            # get its maximum range
            range_nm = sensor.FOV_MaximumRange();
            break;
         }
      }
   }
   
   return range_nm;
end_script

# capture positions after dynamic placement
execute at_time 2 s absolute
   if (!positions_recorded && file_is_open)
   {
      positions_recorded = true;
      
      # reference point for distance calculations
      WsfGeoPoint reference_point = WsfGeoPoint();
      reference_point.Set(53.0, 14.0, 0.0);
      
      
      int platCount = WsfSimulation.PlatformCount();
      for (int i = 0; i < platCount; i += 1)
      {
         WsfPlatform plat = WsfSimulation.PlatformEntry(i);
         
         # skip
         if (!plat.IsValid() || plat.CategoryMemberOf("missile"))
         {
            continue;
         }
         
         
         string platName = plat.Name();
         string platType = plat.Type();
         string platSide = plat.Side();
         
         # skip certain platform types we don't want to track
         if (platType == "POI" || platName.Contains("POI"))
         {
            continue;
         }
         
         # Get location
         WsfGeoPoint location = plat.Location();
         double lat = location.Latitude();
         double lon = location.Longitude();
         double alt_m = plat.Altitude();
         double alt_ft = alt_m * 3.28084;  # meters to feet
         
         # Calculate distances from reference point in nautical miles
         # latitude difference: 1 degree latitude = 60 nautical miles
         double lat_diff_nm = (lat - 53.0) * 60.0;
         
         # Longitude difference: varies with latitude
         # At 53N, 1 degree longitude  ex: distance = 60 x cos(latitude) 60 x cos(53) = 36.2 nautical miles
         double cos_lat = Math.Cos(53.0 * Math.RAD_PER_DEG());
         double lon_diff_nm = (lon - 14.0) * 60.0 * cos_lat;
         
        
         double sensor_range = getLargeRCSSensorRange(plat);
         
         
         Array<string> data = {
            Format.Fixed(TIME_NOW, 2),
            platName,
            platType,
            platSide,
            Format.Fixed(lat, 6),
            Format.Fixed(lon, 6),
            Format.Fixed(alt_ft, 1),
            Format.Fixed(lat_diff_nm, 2),
            Format.Fixed(lon_diff_nm, 2),
            Format.Fixed(sensor_range, 1)
         };
         
         string data_line = ",".Join(data);
         position_csv.Write(data_line);
         position_csv.Write("\n");
      }
      
      # Log completion
      writeln("Platform positions recorded at T=", TIME_NOW, " seconds");
   }
end_execute